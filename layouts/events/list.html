{{ define "main" }}
  <article class="post">
    <header>
      <h1>{{ .Title }}</h1>
    </header>
    
    <div class="content">
      {{ .Content }}
    </div>

    {{/* --- ⬇️ NYTT LOGIKBLOCK ⬇️ --- */}}
    {{/* 1. Hämta alla evenemang från det *aktuella* språket */}}
    {{ $all_events := where .Site.RegularPages "Section" "events" }}

    {{/* 2. Hämta alla andra språk-sajter (exklusive den aktuella) */}}
    {{ $otherSites := complement (slice .Site) site.Sites }}

    {{/* 3. Loopa igenom de andra sajterna och "slå ihop" deras evenemang */}}
    {{ range $otherSites }}
      {{ $all_events = $all_events | lang.Merge (where .RegularPages "Section" "events") }}
    {{ end }}
    {{/* --- ⬆️ SLUT PÅ NYTT BLOCK ⬆️ --- */}}
    
    {{/* Resten av mallen är nu densamma, men körs på den sammanslagna listan */}}
    {{ $now := now }}
    {{ $langParams := .Site.Language.Params }}

    <section class="events-list-section" style="margin-top: 2em;">
      <h2>{{ T "event.one-off-title" | default "One-off Events" }}</h2>
      
      {{ $one_off_pages := where $all_events "Params.start_date" "ne" nil }}
      
      {{ $future_one_off := slice }}
      {{ range $one_off_pages }}
        {{ if (time .Params.start_date).After $now }}
          {{ $future_one_off = $future_one_off | append . }}
        {{ end }}
      {{ end }}
      {{ $sorted_one_off := sort $future_one_off "Params.start_date" "asc" }}

      {{ if ge (len $sorted_one_off) 1 }}
        <ul class="event-card-list">
          {{ range $sorted_one_off }}
            {{ $pageLangParams := .Language.Params }}
            {{ $eventTime := time .Params.start_date }}
            
            <li class="event-card">
              <div class="event-card-info">
                <h3 class="event-card-title"><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
                {{ with .Params.summary }}
                  <p class="event-card-summary">{{ . }}</p>
                {{ end }}
              </div>
              <div class="event-card-details">
                <p>
                  <strong>{{ T "when" }}:</strong> 

                  {{ $eventTime := time .Params.start_date }}
                  {{ $format := $.Site.Language.Params.datetime_format | default "Mon, Jan 2, 2006 at 3:04 PM" }}
                  {{ $dateTime := time.Format $format $eventTime }}
                  {{ $dateTime }} 
                  ({{ time.Format "MST" $eventTime }})
                </p>
                {{ with .Params.location }}
                  <p><strong>{{ T "where" }}:</strong> {{ . }}</p>
                {{ end }}
              </div>
            </li>
          {{ end }}
        </ul>
      {{ else }}
        <p>{{ T "event.no-upcoming-one-off" }}</p>
      {{ end }}
    </section>

    <hr style="border-color: var(--main-border, #444); margin-top: 2em; margin-bottom: 2em;">

    <section class="events-list-section">
      <h2>{{ T "event.recurring-title" | default "Recurring Events" }}</h2>
      
      {{ $recurring_pages := where $all_events "Params.recurrence" "ne" nil }}
      {{ $sorted_recurring := sort $recurring_pages "Title" "asc" }}
      {{ $today_string := $now.Format "2006-01-02" }}

      {{ if ge (len $sorted_recurring) 1 }}
        <ul class="event-card-list">
          {{ range $sorted_recurring }}
            
            {{ $recur := .Params.recurrence }}
            {{ $cancellations := $recur.cancellations | default (slice) }}
            
            {{ $next_occurrence := "" }}
            {{ $upcoming_dates := slice }}
            
            {{ range $recur.schedule }}
              {{ $date_string := . }}
              {{ if ge $date_string $today_string }}
                {{ if not (in $cancellations $date_string) }}
                  {{ $upcoming_dates = $upcoming_dates | append (time $date_string) }}
                {{ end }}
              {{ end }}
            {{ end }}
            
            {{ if ge (len $upcoming_dates) 1 }}
              {{ $next_occurrence = index $upcoming_dates 0 }}
            {{ end }}

            <li class="event-card">
              <div class="event-card-info">
                <h3 class="event-card-title"><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
                {{ with .Params.summary }}
                  <p class="event-card-summary">{{ . }}</p>
                {{ end }}
              </div>
              <div class="event-card-details">
                <p>
                  <strong>{{ T "event.schedule" | default "Schedule" }}:</strong> 
                  {{ $recur.type }} 
                  ({{ $recur.details }})
                </p>

                {{ if $next_occurrence }}
                  <p>
                    <strong>{{ T "event.next" | default "Next" }}:</strong> 
                    {{ time.Format ($langParams.date_format | default "Mon, Jan 2, 2006") $next_occurrence }}
                  </p>
                {{ else }}
                  <p><strong>{{ T "event.next" | default "Next" }}:</strong> {{ T "event.no-new-dates" | default "No new dates scheduled." }}</p>
                {{ end }}
                
                <p>
                  <strong>{{ T "event.time" | default "Time" }}:</strong> 
                  {{ $recur.start_time }} - {{ $recur.end_time }} 
                  ({{ .Site.Params.timeZoneAbbr }})
                </p>
                {{ with .Params.location }}
                  <p><strong>{{ T "where" }}:</strong> {{ . }}</p>
                {{ end }}
              </div>
            </li>
          {{ end }}
        </ul>
      {{ else }}
        <p>{{ T "event.no-upcoming-recurring" }}</p>
      {{ end }}
    </section>
  
  </article>
{{ end }}
