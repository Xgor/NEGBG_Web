{{ define "main" }}

{{ $dataResource := .Resources.GetMatch "data.toml" | default (.Resources.GetMatch "schedule.toml") }}
{{ $data := dict }}
{{ $is_bundle := false }}

{{ if $dataResource }}
  {{ $is_bundle = true }}
  {{ $data = $dataResource.Content | unmarshal }}
{{ else }}
  {{ $data = .Params }}
{{ end }}

{{/* Hämta platsen från .md-filen (Params) */}}
{{ $location := .Params.location }}

{{/* Slå ihop recurrence-data från data.toml med recurrence-text från .md */}}
{{ $recur_data := $data.recurrence | default (dict) }}
{{ $recur_text := .Params.recurrence | default (dict) }}
{{ $recurrence := merge $recur_data $recur_text }}

{{/* Hämta start/end-datum för engångsevenemang */}}
{{ $start_date := $data.start_date }}
{{ $end_date := $data.end_date }}

<article class="post">
  <header>
    <h1>{{ .Title }}</h1>
    
    <div class="post-meta" style="margin-bottom: 2em; line-height: 1.6;">
      
      {{ if $recurrence.type }}
        {{/* --- Info for RECURRING events --- */}}
        <div class="event-schedule">
          <strong>{{ T "event.schedule" }}:</strong>
          <strong>{{ $recurrence.type }}</strong>
          ({{ $recurrence.details }} {{ T "from" }} {{ $recurrence.start_time }} {{ T "to" }} {{ $recurrence.end_time }})
          ({{ .Site.Params.timeZoneAbbr }})
        </div>

      {{ else if $start_date }}
        {{/* --- Info for ONE-OFF events --- */}}
        <div class="event-time">
          <strong>{{ T "when" }}:</strong> 
          {{ $eventTime := time $start_date }}
          {{ $format := $.Site.Language.Params.datetime_format | default "Mon, Jan 2, 2006 at 3:04 PM" }}
          {{ $dateTime := time.Format $format $eventTime }}
          {{ $dateTime }}
          {{ with $end_date }}
            {{ T "to" }} {{ (time .).Format "15:04" }}
          {{ end }}
        </div>
      {{ end }}
      
      {{ with $location }}
        <div class="event-location" style="margin-top: 0.5em;">
          <strong>{{ T "where" }}:</strong> {{ . }}
        </div>
      {{ end }}
    </div>
  </header>
  
  {{/* --- Renders the main markdown content --- */}}
  <div class="content">
    {{ .Content }}
  </div>

  {{ if $recurrence.schedule }}
    {{ $recur := $recurrence }}

    {{ with $recur.cancellations }}
      {{ $future_cancellations := slice }}
      {{ $today_string := now.Format "2006-01-02" }}
      
      {{ range . }}
        {{ $cancellation_string := (time .).Format "2006-01-02" }}
        {{ if ge $cancellation_string $today_string }}
          {{ $future_cancellations = $future_cancellations | append (time .) }}
        {{ end }}
      {{ end }}

      {{ if ge (len $future_cancellations) 1 }}
        <div class="event-cancellations" style="background-color: var(--secondary-bg, #252525); border: 1px solid var(--main-border, #444); padding: 1em; margin-top: 2em; border-radius: 4px;">
          <h3 style="margin-top: 0;"> ⚠️ {{ T "event.upcoming-cancellations-title" | default "Upcoming Cancelled Dates" }}</h3>
          <ul style="margin-top: 0.5em; margin-bottom: 0;">
            {{ range sort $future_cancellations }}
              <li>{{ partial "dates.html" . }}</li>
            {{ end }}
          </ul>
        </div>
      {{ end }}
    {{ end }}


    <div class="event-details" style="margin-top: 2em;">
      <h3 style="margin-top: 0;">{{ T "event.upcoming-occurrences-title" }}</h3>
      
      {{ $schedule := $recur.schedule }}
      {{ $cancellations := $recur.cancellations | default (slice) }}
      {{ $today_string := now.Format "2006-01-02" }}
      
      {{ $upcoming_dates := slice }}
      {{ range $schedule }}
        {{ $date_string := . }}
        {{ if ge $date_string $today_string }}
          {{ if not (in $cancellations $date_string) }}
            {{ $upcoming_dates = $upcoming_dates | append (time $date_string) }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ if ge (len $upcoming_dates) 1 }}
        <p>{{ T "event.upcoming-occurrences-intro" }} ({{ T "from" }} {{ $recur.start_time }} {{ T "to" }} {{ $recur.end_time }}):</p>
        <ul>
          {{ range first 10 $upcoming_dates }}
            <li>{{ partial "dates.html" . }}</li>
          {{ end }}
        </ul>
      {{ else }}
        <p>{{ T "event.no-new-dates" }}</p>
      {{ end }}
    </div>
  {{ end }} {{/* End "if $recurrence.schedule" */}}

</article>
{{ end }}
