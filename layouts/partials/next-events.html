{{/* 1. Hämta alla eventsidor från det *aktuella* språket */}}
{{ $preferredEvents := where .Site.RegularPages "Section" "events" }}

{{/* 2. Hämta alla andra språk-sajter (exklusive den aktuella) */}}
{{ $otherSites := complement (slice .Site) site.Sites }}

{{/* 3. Loopa igenom de andra språken och "slå ihop" deras eventsidor */}}
{{ range $otherSites }}
  {{ $preferredEvents = $preferredEvents | lang.Merge (where .RegularPages "Section" "events") }}
{{ end }}

{{/* 4. Nu har vi en ren lista med evenemangssidor. Bygg master-listan. */}}
{{ $now := now }}
{{ $today_string := $now.Format "2006-01-02" }}
{{ $master_event_list := slice }}

{{ range $preferredEvents }}
  {{ $page := . }}
  
  {{ $data := dict }}
  {{ $recurrence := dict }}
  {{ $start_date := "" }}
  {{ $end_date := "" }}

  {{/* Leta efter datafilen (data.toml ELLER schedule.toml) */}}
  {{ $dataResource := .Resources.GetMatch "data.toml" | default (.Resources.GetMatch "schedule.toml") }}
  
  {{ if $dataResource }}
    {{/* Det är en Page Bundle (Ny stil) */}}
    {{ $data = $dataResource.Content | unmarshal }}
    
    {{/* Slå ihop datan: text från sidan, schema/tider från datafilen */}}
    {{ $recur_data := $data.recurrence | default (dict) }}
    {{ $recur_text := $page.Params.recurrence | default (dict) }}
    {{ $recurrence = merge $recur_data $recur_text }}
    
    {{ $start_date = $data.start_date }}
    {{ $end_date = $data.end_date }}
    
  {{ else }}
    {{/* Det är en enkel sida (Gammal stil, fallback) */}}
    {{ $start_date = .Params.start_date }}
    {{ $end_date = .Params.end_date }}
    {{ $recurrence = .Params.recurrence }}
  {{ end }}
  

  {{ if $start_date }}
    {{/* Logik för engångsevenemang */}}
    {{ $event_time := time $start_date }}
    {{ if $event_time.After $now }}
      {{ $master_event_list = $master_event_list | append (dict
          "Page" $page
          "SortDate" $event_time
          "Time" (printf "%s - %s" ($event_time.Format "15:04") ((time $end_date).Format "15:04"))
        )
      }}
    {{ end }}

  {{ else if $recurrence.schedule }}
    {{/* Logik för återkommande evenemang */}}
    {{ $recur := $recurrence }}
    
    {{ if $recur.start_time }}
      {{ $cancellations := $recur.cancellations | default (slice) }}
      {{ $start_time_str := $recur.start_time }}
      {{ $end_time_str := $recur.end_time }}
      {{ $time_range_str := printf "%s - %s" $start_time_str $end_time_str }}

      {{ range $recur.schedule }}
        {{ $date_string := . }}
        {{ if ge $date_string $today_string }}
          {{ if not (in $cancellations $date_string) }}
            {{ $event_datetime_string := printf "%sT%s:00" $date_string $start_time_str }}
            {{ $event_time := time $event_datetime_string }}
            {{ $master_event_list = $master_event_list | append (dict
                "Page" $page
                "SortDate" $event_time
                "Time" $time_range_str
              )
            }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ else }}
      {{ warnf "Event '%s' has a 'recurrence' block but is missing 'start_time'. It will not be listed." $page.File.Path }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* 5. Sortera och visa listan  */}}
{{ $sorted_events := sort $master_event_list "SortDate" "asc" }}
{{ $next_5_events := first 5 $sorted_events }}

<section class="next-events">
  <h2>{{ T "event.upcoming-title" | default "Upcoming Events" }}</h2>
  {{ if ge (len $next_5_events) 1 }}
    <ul class="event-card-list">
      {{ range $next_5_events }}
        {{ partial "event-summary.html" . }}
      {{ end }}
    </ul>
  {{ else }}
    <p>{{ T "event.no-upcoming" | default "No upcoming events are scheduled at this time." }}</p>
  {{ end }}
</section>
