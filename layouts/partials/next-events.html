{{/* 1. Hämta alla eventsidor från det *aktuella* språket */}}
{{ $preferredEvents := where .Site.RegularPages "Section" "events" }}

{{/* 2. Hämta alla andra språk-sajter (exklusive den aktuella) */}}
{{ $otherSites := complement (slice .Site) site.Sites }}

{{/* 3. Loopa igenom de andra sajterna och "slå ihop" deras eventsidor */}}
{{ range $otherSites }}
  {{ $preferredEvents = $preferredEvents | lang.Merge (where .RegularPages "Section" "events") }}
{{ end }}

{{/* 4. Nu har vi en ren lista med evenemangssidor. Bygg master-listan. */}}
{{ $now := now }}
{{ $today_string := $now.Format "2006-01-02" }}
{{ $master_event_list := slice }}

{{ range $preferredEvents }}
  {{ $page := . }}

  {{ if $page.Params.start_date }}
    {{ $event_time := time $page.Params.start_date }}
    {{ if $event_time.After $now }}
      {{ $master_event_list = $master_event_list | append (dict
          "Page" $page
          "SortDate" $event_time
          "Time" (printf "%s - %s" ($event_time.Format "15:04") ((time $page.Params.end_date).Format "15:04"))
        )
      }}
    {{ end }}

  {{ else if $page.Params.recurrence.schedule }}
    
    {{ $recur := $page.Params.recurrence }}
    
    {{ if $recur.start_time }}
      {{ $cancellations := $recur.cancellations | default (slice) }}
      {{ $start_time_str := $recur.start_time }}
      {{ $end_time_str := $recur.end_time }}
      {{ $time_range_str := printf "%s - %s" $start_time_str $end_time_str }}

      {{ range $recur.schedule }}
        {{ $date_string := . }}
        
        {{ if ge $date_string $today_string }}
          {{ if not (in $cancellations $date_string) }}
          
            {{ $event_datetime_string := printf "%sT%s:00" $date_string $start_time_str }}
            {{ $event_time := time $event_datetime_string }}

            {{ $master_event_list = $master_event_list | append (dict
                "Page" $page
                "SortDate" $event_time
                "Time" $time_range_str
              )
            }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ else }}
      {{ warnf "Event '%s' has a 'recurrence' block but is missing 'start_time'. It will not be listed." $page.File.Path }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* 5. Sortera och visa listan (oförändrad) */}}
{{ $sorted_events := sort $master_event_list "SortDate" "asc" }}
{{ $next_5_events := first 5 $sorted_events }}

<section class="next-events">
  <h2>Recent News</h2>
  {{ if ge (len $next_5_events) 1 }}
    <ul class="event-card-list">
      {{ range $next_5_events }}
        {{ partial "event-summary.html" . }}
      {{ end }}
    </ul>
  {{ else }}
    <p>No upcoming events are scheduled at this time.</p>
  {{ end }}
</section>
