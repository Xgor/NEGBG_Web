{{/* This layout builds a single, sorted list of all future event occurrences.
*/}}
{{ $all_pages := where .Site.RegularPages "Section" "events" }}
{{ $now := now }}
{{ $today_string := $now.Format "2006-01-02" }}

{{/* 1. Create an empty list to hold all upcoming event instances */}}
{{ $master_event_list := slice }}

{{/* 2. Loop through every event page */}}
{{ range $all_pages }}
  {{ $page := . }}

  {{ if $page.Params.start_date }}
    {{/* --- A. Handle ONE-OFF events --- */}}
    {{ $event_time := time $page.Params.start_date }}
    {{ if $event_time.After $now }}
      {{ $master_event_list = $master_event_list | append (dict
          "Page" $page
          "SortDate" $event_time
          "Time" (printf "%s - %s" ($event_time.Format "15:04") ((time $page.Params.end_date).Format "15:04"))
        )
      }}
    {{ end }}

  {{ else if $page.Params.recurrence.schedule }}
    {{/* --- B. Handle RECURRING events --- */}}
    
    {{/* Get data from the nested recurrence block */}}
    {{ $recur := $page.Params.recurrence }}
    {{ $cancellations := $recur.cancellations | default (slice) }}
    {{ $start_time_str := $recur.start_time }}
    {{ $end_time_str := $recur.end_time }}
    {{ $time_range_str := printf "%s - %s" $start_time_str $end_time_str }}

    {{/* Loop through every date in this event's schedule */}}
    {{ range $recur.schedule }}
      {{ $date_string := . }}
      
      {{/* Check 1: Is the date today or in the future? */}}
      {{ if ge $date_string $today_string }}
      
        {{/* Check 2: Is this date in the cancellations list? */}}
        {{ if not (in $cancellations $date_string) }}
        
          {{/* It's a valid, future event. Add it to the master list. */}}
          {{ $event_datetime_string := printf "%sT%s:00+01:00" $date_string $start_time_str }}
          {{ $event_time := time $event_datetime_string }}

          {{ $master_event_list = $master_event_list | append (dict
              "Page" $page
              "SortDate" $event_time
              "Time" $time_range_str
            )
          }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}


{{/* 3. Sort the final master list by date and take the first 5 */}}
{{ $sorted_events := sort $master_event_list "SortDate" "asc" }}
{{ $next_5_events := first 5 $sorted_events }}

<section class="next-events">
  <h2>Next 5 Events</h2>
  {{ if ge (len $next_5_events) 1 }}
    <ul class="event-card-list">
      {{ range $next_5_events }}
        {{ partial "event-summary.html" . }}
      {{ end }}
    </ul>
  {{ else }}
    <p>No upcoming events are scheduled at this time.</p>
  {{ end }}
</section>
